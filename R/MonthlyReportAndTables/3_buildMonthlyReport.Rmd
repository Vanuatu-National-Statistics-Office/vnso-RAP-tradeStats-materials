---
title: "International Merchandise Trade Statistics - `r format(Sys.Date(), '%B %Y')` Highlights"
output: 
  word_document:
    reference_docx: styles_reference.docx
---

```{r setup, include=FALSE}
# Set echo=FALSE as default for code cells
knitr::opts_chunk$set(echo=FALSE)
# Load the required libraries
library(knitr) # Creating documents
library(flextable) # Nicely formatted tables
library(rnaturalearth) # World map
library(sf) # Working with spatial data
library(ggplot2) # Creating plots
library(dplyr) # Working with data
library(tidyr) # For pivoting data.frames
# Set the table formatting defaults
set_flextable_defaults(font.family="Times New Roman", font.size=5, font.color="black",
                       text.align="left", table.layout="fixed", theme_fun="theme_booktabs")
# Note where VNSO code/data is on current computer
repository <- file.path("..", "..")
# Note the open data path
openDataFolder <- file.path(repository, "data", "open")
# Note the secure data path
secureDataFolder <- file.path(repository, "data", "secure")
# Load the general R functions
source(file.path(repository, "R", "functions.R"))
# Load the processed trade statistics for month of interest
processedTradeStats <- read.csv(file.path(secureDataFolder, "OUT_PROC_ASY_ProcessedRawData_31-01-20.csv"))
```

# National Sustainable Development Plan Indicators (NSDP)

```{r NSDP indicators}
### Calculating NSDP Indicators


## ECO 1.5.2 Trade by trade agreement (value)
## Proxy calculated: value of all international trade registered under a trade agreement- only imports registered, exports estimated (all exports to MSG countries included)

# Calculate value of imports that are from countries that have signed the MSG and PICTA trade agreements
tradeAgreementMonthlyImports <- processedTradeStats[is.na(processedTradeStats$PRF) == FALSE & processedTradeStats$PRF %in% c("MSG", "PICTA"), ]
tradeAgreementMonthlyImportValue<- sum(tradeAgreementImports$Stat..Value)

# Calculate value of all exports that are destined to countries that have signed the MSG trade agreement (proxy measure)
tradeAgreementProxyCurrentMonthExportValue <- sum(processedTradeStats[processedTradeStats$CP4 == 1000 & processedTradeStats$EXPORT.COUNTRY %in% c("FIJI", "NEW CALEDONIA", "PAPUA NEW GUINEA", "SOLOMON ISLANDS"), "Stat..Value"], na.rm=TRUE) #need to exclude re-exports from this calculation

# Proxy indicator calculated for NSDP indicator ECO 1.5.2 by combining imports and proxy exports
proxyIndictaorCalucluated1.5.2<- tradeAgreementMonthlyImportValue + tradeAgreementProxyMonthlyExportValue

# Insert values into table
proxyIndictaor1.5.2DataFrame <- data.frame("Trade by Trade Agreement Value"= proxyIndictaorCalucluated1.5.2)


## Calculate ECO 1.5.3 Balance of Trade by major partner countries 

# Define the CP4 codes need for Exports table 
codesCP4 <- c(1000, 3071) 

# Define the categories used for each column
categoryColumn <- "EXPORT.COUNTRY"
columnCategories <- list(
  "Australia: Exports"=c("AUSTRALIA"),
  "China, People's Republic of: Exports"=c("CHINA, PEOPLES REPUBLIC OF"),
  "Fiji: Exports"=c("FIJI"),
  "France: Exports"=c("FRANCE"),
  "Hong Kong: Exports"=c("HONG KONG"),
  "India: Exports"=c("INDIA"),
  "Indonesia: Exports"=c("INDONESIA"),
  "Japan: Exports"=c("JAPAN"),
  "Korea, Republic Of: Exports"=c("KOREA, REPUBLIC OF"),
  "Malaysia: Exports"=c("MALAYSIA"),
  "Netherlands: Exports"=c("NETHERLANDS"),
  "New Caledonia: Exports"=c("NEW CALEDONIA"),
  "New Zealand: Exports"=c("NEW ZEALAND"),
  "Papua New Guinea: Exports"=c("PAPUA NEW GUINEA"),
  "Philippines: Exports"=c("PHILIPPINES"),
  "Singapore: Exports"=c("SINGAPORE"),
  "Solomon Islands: Exports"=c("SOLOMON ISLANDS"),
  "Thailand: Exports"=c("THAILAND"),
  "United Kingdom: Exports"=c("UNITED KINGDOM"),
  "United States of America: Exports"=c("UNITED STATES OF AMERICA")
)

# Build the table
totalPartnerCountryExports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)

# Define the CP4 codes need for Imports table
codesCP4 <- c(4000, 4071, 7100)

# Define the categories used for each column
categoryColumn <- "IMPORT.COUNTRY"
columnCategories <- list(
  "Australia: Imports"=c("AUSTRALIA"),
  "China, People's Republic of: Imports"=c("CHINA, PEOPLES REPUBLIC OF"),
  "Fiji: Imports"=c("FIJI"),
  "France: Imports"=c("FRANCE"),
  "Hong Kong: Imports"=c("HONG KONG"),
  "India: Imports"=c("INDIA"),
  "Indonesia: Imports"=c("INDONESIA"),
  "Japan: Imports"=c("JAPAN"),
  "Korea, Republic Of: Imports"=c("KOREA, REPUBLIC OF"),
  "Malaysia: Imports"=c("MALAYSIA"),
  "Netherlands: Imports"=c("NETHERLANDS"),
  "New Caledonia: Imports"=c("NEW CALEDONIA"),
  "New Zealand: Imports"=c("NEW ZEALAND"),
  "Papua New Guinea: Imports"=c("PAPUA NEW GUINEA"),
  "Philippines: Imports"=c("PHILIPPINES"),
  "Singapore: Imports"=c("SINGAPORE"),
  "Solomon Islands: Imports"=c("SOLOMON ISLANDS"),
  "Thailand: Imports"=c("THAILAND"),
  "United Kingdom: Imports"=c("UNITED KINGDOM"),
  "United States of America: Imports"=c("UNITED STATES OF AMERICA")
)

# Build the table
totalPartnerCountryImports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)

# Indicator calculated for NSDP indicator ECO 1.5.3 by subtracting total imports from exports 
monthlyBalanceOfTradeByMajorPartnerCountries <- totalPartnerCountryExports - totalPartnerCountryImports
indicator1.5.3Calculated<- monthlyBalanceOfTradeByMajorPartnerCountries$Total

# Insert values into table
indictaor1.5.3DataFrame <- data.frame("Balance of Trade by Major Partner Countries"= indicator1.5.3Calculated)


## ECO 1.6.2 Total estimated value of trade agreement as a proportion of GDP
## Proxy calculated: estimated value of trade agreements and use of 2018 GDP calculation  

# Read in the data from the open folder of the repository for GDP
grossDomesticProductFile <- file.path(openDataFolder, "OPN_FINAL_VNSO_GDPAnnualCalculations_31-12-18.csv")
timeSeriesGrossDomesticProduct <- read.csv(grossDomesticProductFile)

# Rename column headers and order the data
colnames(timeSeriesGrossDomesticProduct) <- c("Year", "Value")
timeSeriesGrossDomesticProduct <- timeSeriesGrossDomesticProduct[order(timeSeriesGrossDomesticProduct$Year), ]

# Proxy indicator calculated for NSDP ECO 1.6.2 by dividing latest GDP figure by Trade Agreement value
mostRecentGrossDomesticProduct <- timeSeriesGrossDomesticProduct[nrow(timeSeriesGrossDomesticProduct), "Value"] #identify 2018 GDP
proxyIndicatorCalucluated1.6.2<- (proxyIndictaorCalucluated1.5.2/mostRecentGrossDomesticProduct)*100

# Insert values into table as a percentage to 2 decimal places
proxyIndicatorCalucluated1.6.2<- round(proxyIndicatorCalucluated1.6.2, digits = 2)
proxyIndictaor1.6.2DataFrame <- data.frame("Value of Trade Agreement as Proportion of GDP"= proxyIndicatorCalucluated1.6.2)


## Calculate ECO 1.7.1 Level of production of major commodities to include Cocoa and Copra
## Proxy calculated: level of production of major exported commodities to include beef, cocoa, coconut oil, coffee, copra, fish tuna, kava and wood 

# CP4 code for exports
codesCP4 <- c(1000) 

# Define the categories used for each column
categoryColumn <- "Principle.Exports"
columnCategories <- list(
  "Beef fresh, chilled, frozen and preserved"=c("Beef fresh, chilled, frozen and preserved"),
  "Cocoa"=c("Cocoa"),
  "Coconut oil"=c("Coconut Oil"),
  "Coffee, all types"=c("Coffee, all types"),
  "Copra"=c("Copra"),
  "Fish: Tuna"=c("Fish: Tuna"),
  "Kava"=c("Kava"),
  "Wood and articles of wood; wood charcoal"=c("Wood and articles of wood; wood charcoal")
)

# Build the table
totalMajorExportCommodities <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)

# Proxy indicator for NSDP ECO 1.7.1
aggregatedTotalPrincipleExports<- totalMajorExportCommodities$Total
proxyIndictaor1.7.1DataFrame <- data.frame("Level of production of major commodities to include Cocoa and Copra"= aggregatedTotalPrincipleExports)



### Calculating Progress Against NSDP Indicator Targets

## ECO 1.5.2 Trade by trade agreement (value), Target 2020 exports increase by 15%
## Proxy calculated: value of all international trade registered under a trade agreement- only imports registered, exports estimated (all exports to MSG countries included)

# Read in the data from the secure folder of the repository (need to calculate baseline indicators- NDSP launched in 2017, baseline taken from 2016)
historicalExportsFile <- file.path(secureDataFolder,"exports_HS_summaryStats_02-10-20.csv")
historicalExports <- read.csv(historicalExportsFile)

# Create subset of all international exports to MSG countries in 2016 the baseline year
tradeStatsMSGExports2016<- historicalExports[historicalExports$Year == 2016, ]
tradeStatsMSGExports<- tradeStatsMSGExports2016[tradeStatsMSGExports2016$Procedure == 1000 &     tradeStatsMSGExports2016$CTY_Dest %in% c("FJ", "NC", "PG", "SB"), ]

# Calculate value of Trade Agreements by month for baseline year
tradeStatsMSGExports$Value <- as.numeric(gsub(",", "", tradeStatsMSGExports$Value))# Convert the statistical value to numeric
totalMonthlyValueTradeAgreementsExports <- tradeStatsMSGExports %>%
  group_by(Month) %>%
  summarise(total = sum(Value))

# Calculate value of Trade Agreements for current month from baseline year
tradeAgreementCurrentMonthBaselineValue <- sum(totalMonthlyValueTradeAgreementsExports[totalMonthlyValueTradeAgreementsExports$Month == 1, "total"], na.rm= TRUE)

# Calculate ECO 1.5.2 Trade by trade agreement (value), Target 2020 exports increase by 15% 
percentageChangeCurrentMonthMSGExports<- ((tradeAgreementProxyCurrentMonthExportValue - tradeAgreementCurrentMonthBaselineValue)/tradeAgreementCurrentMonthBaselineValue)*100 # needs to be 15% to meet Target
 

## Calculate ECO 1.5.3 Balance of Trade by major partner countries, Target 2020 exports increase by 20%

# Read in the data from the secure folder of the repository. Need to calculate Baseline indicators. NSDP launched in 2017, use 2016 data for baseline 
tradeStatsExports2016<- historicalExports[historicalExports$Year == 2016, ]

# Merge export country classifications with historical data 
tradeStatsFileMergeCountryDesExports <- file.path(openDataFolder, "OPN_FINAL_ASY_CountryDescriptionExportClassifications_31-01-20.csv") 
countryDescriptionExports <- read.csv(tradeStatsFileMergeCountryDesExports)
tradeStatsExports2016MergedWithClassifications <- merge(tradeStatsExports2016, countryDescriptionExports, by="CTY_Dest", all.x=TRUE)

# Create a subset for all major partner countries 
historicalTradeStatsExportsMajorPartnerCountries<- tradeStatsExports2016MergedWithClassifications[tradeStatsExports2016MergedWithClassifications$EXPORT.COUNTRY %in% c("AUSTRALIA", "CHINA, PEOPLES REPUBLIC OF", "FIJI", "FRANCE", "HONG KONG", "INDIA", "INDONESIA", "JAPAN", "KOREA, REPUBLIC OF", "MALAYSIA", "NETHERLANDS", "NEW CALEDONIA", "NEW ZEALAND", "PAPUA NEW GUINEA", "PHILIPPINES", "SINGAPORE", "SOLOMON ISLANDS", "THAILAND", "UNITED KINGDOM", "UNITED STATES OF AMERICA"), ]

# Calculate monthly values of major partner countries for 2016 baseline year
monthlyValueMajorPartnerCountryExports <- historicalTradeStatsExportsMajorPartnerCountries %>%
  group_by(Month, EXPORT.COUNTRY) %>%
  summarise(total = sum(Value))

totalMonthlyValueMajorPartnerCountryExports <- monthlyValueMajorPartnerCountryExports %>%
  group_by(Month) %>%
  summarise(total = sum(total))
















# ECO 1.6.2, proxy calculated: Total estimated value of trade agreement as proportion of GDP, all exports included to MSG countries- 2030 increase by 15%
# Read in the data from the open folder of the repository 
estimatedTradeAgreementCommodities<- rbind(tradeStatsMSGImports2019, tradeStatsMSGExports2019)
grossDomesticProductFile <- file.path(openDataFolder, "OPN_FINAL_VNSO_GDPAnnualCalculations_31-12-18.csv")
timeSeriesGrossDomesticProduct <- read.csv(grossDomesticProductFile)
# Calculate value of Trade Agreements by month
estimatedTradeAgreementCommodities$Stat..Value <- as.numeric(gsub(",", "", estimatedTradeAgreementCommodities$Stat..Value))# Convert the statistical value to numeric
totalMonthlyValueTradeAgreements <- estimatedTradeAgreementCommodities %>%
  group_by(Month) %>%
  summarise(total = sum(Stat..Value))
# Calculate progress of NSDP (proxy indicator- ECO 1.6.2). Target sets an increase of 15% by 2030 (percentage should be 115%) 
mostRecentGrossDomesticProduct<- timeSeriesGrossDomesticProduct[13, 2] #identify 2018 GDP
tradeAgreementValueProportionGDP<- (msgTradeAgreementProxyValue/mostRecentGrossDomesticProduct)*100

# ECO 1.7.1 Calculate Target: level of production of major commodities to include cocoa and copra- 2030 increase 10-15% of the proportion


# Create the NSDP table
nsdpIndicators <- data.frame(
  "Policy Objectives"=c("ECO 1.4: Increase trade and investment opportunities and reduce barriers, including through the use of Aid-for-Trade",
                        "ECO 1.5: Increase access to markets for Vanuatu exports",
                        "ECO 1.5: Increase access to markets for Vanuatu exports",
                        "ECO 1.5: Increase access to markets for Vanuatu exports",
                        "ECO 1.6: Require all new trade agreements to demonstrate tangible benefits in the national interest",
                        "ECO 1.7: Stimulate economic diversification to spread the benefits of growth and increase economic stability"),
  "SMART Indicators"=c("ECO 1.4.1 Value and volume of national trade/merchandise trade",
                       "ECO 1.5.2 Trade by trade agreement (value)",
                       "ECO 1.5.3 Balance of trade by major partner countries",
                       "ECO 1.6.2 Total estimated value of trade agreement as proportion of GDP",
                       "ECO 1.7.1 Level of production of major commodities to include cocoa and copra"),
  "Indicator Value (Increased/Decreased)"=NA,
  "Targets 2030"=c("By 2030 increase of 20%",
                   "By 2020, exports increase by 15%",
                   "By 2020, exports increase by 20%",
                   "By 2030 increase by 15%",
                   "By 2030 increase 10-15% of the proportion"),
  "Target Percentage (%)"=NA, 
  check.names=FALSE, stringsAsFactors=FALSE)
# Initiailise a flextable object for NSDP table
indicatorsTable <- flextable(nsdpIndicators)
# Add a header row and set background colour
indicatorsTable <- add_header_row(indicatorsTable, top=TRUE, 
                     values=c("NSDP Pillar 3: Economy Pillar\nECONOMY 1: A stable and prosperous economy, encouraging trade, investment and providing economic opportunities for all members of society throughout Vanuatu"), 
                     colwidths=ncol(nsdpIndicators))
indicatorsTable <- bg(indicatorsTable, bg="coral1", part="header")
# Set the vertical alignment to top
indicatorsTable <- valign(indicatorsTable, valign="top", part="all")
# Merge repeated values in columns
indicatorsTable <- merge_v(indicatorsTable)
# Set table width to 100%
indicatorsTable <- set_table_properties(indicatorsTable, width=1, layout="autofit")
# Set the theme
indicatorsTable <- theme_booktabs(indicatorsTable)
# Print table
indicatorsTable
```

Automated text which states the growth rate that is needed for the policy objectives to meet their target indicators. If the country is on course to achieve the trade related NSDP goals.

# Trade Balance by Major Partner Countries

Automated text of grow of exports and imports over last 1, 5 and 10 years by major countries.

```{r major partner country trade, warning=FALSE, fig.width=5.5, fig.height=2.5}
## Getting latest statistics ##
# Define the CP4 codes need for table
codesCP4 <- c(1000, 3071)
# Define the categories used for each column
categoryColumn <- "EXPORT.COUNTRY"
columnCategories <- list(
  "Australia: Exports"=c("AUSTRALIA"),
  "China, People's Republic of: Exports"=c("CHINA, PEOPLES REPUBLIC OF"),
  "Fiji: Exports"=c("FIJI"),
  "France: Exports"=c("FRANCE"),
  "Hong Kong: Exports"=c("HONG KONG"),
  "India: Exports"=c("INDIA"),
  "Indonesia: Exports"=c("INDONESIA"),
  "Japan: Exports"=c("JAPAN"),
  "Korea, Republic Of: Exports"=c("KOREA, REPUBLIC OF"),
  "Malaysia: Exports"=c("MALAYSIA"),
  "Netherlands: Exports"=c("NETHERLANDS"),
  "New Caledonia: Exports"=c("NEW CALEDONIA"),
  "New Zealand: Exports"=c("NEW ZEALAND"),
  "Papua New Guinea: Exports"=c("PAPUA NEW GUINEA"),
  "Philippines: Exports"=c("PHILIPPINES"),
  "Singapore: Exports"=c("SINGAPORE"),
  "Solomon Islands: Exports"=c("SOLOMON ISLANDS"),
  "Thailand: Exports"=c("THAILAND"),
  "United Kingdom: Exports"=c("UNITED KINGDOM"),
  "United States of America: Exports"=c("UNITED STATES OF AMERICA")
)
# Build the table
totalPartnerCountryExports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)
# Calculate the Imports by Major Partner Countries
# Define the CP4 codes need for table
codesCP4 <- c(4000, 4071, 7100)
# Define the categories used for each column
categoryColumn <- "IMPORT.COUNTRY"
columnCategories <- list(
  "Australia: Imports"=c("AUSTRALIA"),
  "China, People's Republic of: Imports"=c("CHINA, PEOPLES REPUBLIC OF"),
  "Fiji: Imports"=c("FIJI"),
  "France: Imports"=c("FRANCE"),
  "Hong Kong: Imports"=c("HONG KONG"),
  "India: Imports"=c("INDIA"),
  "Indonesia: Imports"=c("INDONESIA"),
  "Japan: Imports"=c("JAPAN"),
  "Korea, Republic Of: Imports"=c("KOREA, REPUBLIC OF"),
  "Malaysia: Imports"=c("MALAYSIA"),
  "Netherlands: Imports"=c("NETHERLANDS"),
  "New Caledonia: Imports"=c("NEW CALEDONIA"),
  "New Zealand: Imports"=c("NEW ZEALAND"),
  "Papua New Guinea: Imports"=c("PAPUA NEW GUINEA"),
  "Philippines: Imports"=c("PHILIPPINES"),
  "Singapore: Imports"=c("SINGAPORE"),
  "Solomon Islands: Imports"=c("SOLOMON ISLANDS"),
  "Thailand: Imports"=c("THAILAND"),
  "United Kingdom: Imports"=c("UNITED KINGDOM"),
  "United States of America: Imports"=c("UNITED STATES OF AMERICA")
)
# Build the table
totalPartnerCountryImports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)
# Calculate the Balance of Trade by Major Partner Countries
balanceOfTradeByMajorPartnerCountries <- totalPartnerCountryExports - totalPartnerCountryImports
colnames(balanceOfTradeByMajorPartnerCountries) <- sapply(colnames(balanceOfTradeByMajorPartnerCountries),
                                                          FUN=function(colName){
                                                            return(strsplit(colName, split=":")[[1]][1])
                                                          })
# Get the polygons for the world
worldmap <- rnaturalearth::ne_download(scale = 110,
                                       type = "countries",
                                       category = "cultural",
                                       destdir = tempdir(),
                                       load = TRUE,
                                       returnclass = "sp")
# COnvert to sf spatial feature
world <- sf::st_as_sf(worldmap)
# Generate some example data
countryRecords <- data.frame("ISO3" = sample(world$ADM0_A3, size = 50),
                             "RandomValue" = runif(50))
# Merge in my example data
world <- merge(world, countryRecords, by.x = "ADM0_A3", by.y = "ISO3", all.x = TRUE)
# Plot the map in base R
plot(world["RandomValue"])
# Plot with ggplot
ggplot(data = world) +
    geom_sf(aes(fill = RandomValue))
```

# Trade Balance of Pacific Islands (excluding Melanesian Islands, Australia and New Zealand) 

```{r trade balance of top 5, fig.height=1.75}
## Calculate exports 
# Define the CP4 codes need for table
codesCP4 <- c(1000, 3071)
# Define the categories used for each column
categoryColumn <- "EXPORT.COUNTRY"
columnCategories <- list(
  "American Samoa: Exports"=c("AMERICAN SAMOA"),
  "Tonga: Exports"= c("TONGA"),
  "Cook Islands: Exports"=c("COOK ISLANDS"),
  "Kiribati: Exports"=c("KIRIBATI"),
  "Federated States of Micronesia: Exports"=c("FED. STATES OF MICRONESIA"),
  "Marshall Islands: Exports"=c("MARSHALL ISLANDS"),
  "Nauru: Exports"=c("NAURU"),
  "Niue: Exports"=c("NIUE"),
  "Palau: Exports"=c("PALAU"),
  "Samoa: Exports"=c("SAMOA"),
  "French Polynesia: Exports"=c("FRENCH POLYNESIA"),
  "Tuvalu: Exports"=c("TUVALU"),
  "Wallis and Futuna Islands: Exports"=c("WALLIS AND FUTUNA ISLANDS")
)
# Build the table
totalPacificCountryExports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)
# Select top five Pacific Islands 
orderedtotalPacificCountryExports <- head(sort(totalPacificCountryExports, decreasing= TRUE))
top5PacificCountryExports<- orderedtotalPacificCountryExports %>% select(2:6)
prettyTable(top5PacificCountryExports)
## Calculate imports 
# Define the CP4 codes need for table
codesCP4 <- c(4000, 4071, 7100)
# Define the categories used for each column
categoryColumn <- "IMPORT.COUNTRY"
columnCategories <- list(
  "American Samoa: Exports"=c("AMERICAN SAMOA"),
  "Tonga: Imports"= c("TONGA"),
  "Cook Islands: Exports"=c("COOK ISLANDS"),
  "Kiribati: Exports"=c("KIRIBATI"),
  "Federated States of Micronesia: Exports"=c("FED. STATES OF MICRONESIA"),
  "Marshall Islands: Exports"=c("MARSHALL ISLANDS"),
  "Nauru: Exports"=c("NAURU"),
  "Niue: Exports"=c("NIUE"),
  "Palau: Exports"=c("PALAU"),
  "Samoa: Exports"=c("SAMOA"),
  "French Polynesia: Exports"=c("FRENCH POLYNESIA"),
  "Tuvalu: Exports"=c("TUVALU"),
  "Wallis and Futuna Islands: Exports"=c("WALLIS AND FUTUNA ISLANDS")
)
# Build the table
totalPacificCountryImports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)
# Select top five Pacific Islands 
orderedtotalPacificCountryImports<- head(sort(totalPacificCountryImports, decreasing= TRUE))
top5PacificCountryImports<- orderedtotalPacificCountryImports %>% select(2:6)
prettyTable(top5PacificCountryExports)
# Calculate Trade Balance of Pacific Islands
tradeBalancePacificIslands<- totalPacificCountryExports - totalPacificCountryImports
orderedtradeBalancePacificIslands<- head(sort(tradeBalancePacificIslands, decreasing= TRUE))
prettyTable(orderedtradeBalancePacificIslands)
# Combine Imports and Exports into single table
totalPacificCountryImportsTransposed <- as.data.frame(t(totalPacificCountryImports))
totalPacificCountryImportsTransposed$Country <- gsub(": Exports|: Imports", "", rownames(totalPacificCountryImportsTransposed))
totalPacificCountryExportsTransposed <- as.data.frame(t(totalPacificCountryExports))
totalPacificCountryExportsTransposed$Country <- gsub(": Exports|: Imports", "", rownames(totalPacificCountryExportsTransposed))
pacificCountryTotals <- merge(totalPacificCountryImportsTransposed, totalPacificCountryExportsTransposed,
                              by = "Country", all = TRUE, suffixes = c("Imports", "Exports"))
colnames(pacificCountryTotals) <- gsub("V1", "", colnames(pacificCountryTotals))
# Calculate the trade balance
pacificCountryTotals$Balance <- pacificCountryTotals$Exports - pacificCountryTotals$Imports
# Remove the total row and pivot to be in format for bar chart
pacificCountryTotalsLong <- pacificCountryTotals %>%
  filter(Country != "Total") %>%
  pivot_longer(cols = c("Imports", "Exports", "Balance"), 
               names_to = "Type", values_to = "Value")
# Create a bar chart
ggplot(pacificCountryTotalsLong, aes(x=Country, y=Value, fill=Type)) +
  geom_bar(stat="identity", color="black", position=position_dodge()) +
  theme_minimal() + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title=element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Automated text to highlight trade balance; difference between value of imports and exports comparing this month to same month in previous year.

# Trade Balance of New Emerging Markets

```{r trade balance of new emerging markets, fig.height=1.75}
# Add column to tell us whether each row is import or export
processedTradeStats <- processedTradeStats %>%
  mutate(CommodityType = case_when(CP4 %in% c(4000, 4071, 7100) ~ "IMPORT",
                                   CP4 %in% c(1000) ~ "EXPORT",
                                   CP4 %in% c(3071) ~ "REEXPORT"))
# Calculate total statistical value by country and commodity type
totalCommodityValueByCountryAndType <- processedTradeStats %>%
  group_by(CO, CommodityType) %>%
  summarise(total = sum(Stat..Value), 
            exportCategory = EXPORT.PARTNER.COUNTRIES[1],
            importCategory = IMPORT.PARTNER.COUNTRIES[1],
            country = ifelse(is.na(IMPORT.COUNTRY), EXPORT.COUNTRY[1], IMPORT.COUNTRY[1]),
            .groups = "drop")
# Calculate the trade balance for each country
tradeBalanceByCountry <- totalCommodityValueByCountryAndType %>%
  mutate(totalWithSign = ifelse(CommodityType == "IMPORT", total * -1, total)) %>%
  group_by(CO, country, importCategory) %>%
  summarise(balance = sum(totalWithSign), .groups = "drop")
# Order table by the trade balance
tradeBalanceByCountry <- tradeBalanceByCountry %>%
  arrange(desc(balance))
# Drop Vanuatu
tradeBalanceByCountry <- tradeBalanceByCountry %>%
  filter(country != "VANUATU")
# Select only countries falling into the OTHER category
tradeBalanceByCountryOther <- tradeBalanceByCountry %>%
  filter(importCategory == "OTHERS")
# Create a bar chart to view the top 5 and bottom 5 countries
nRows <- nrow(tradeBalanceByCountryOther)
ggplot(data = tradeBalanceByCountryOther[c(1:5, (nRows-4):nRows), ], 
       aes(x = reorder(country, -balance), y = balance)) +
  geom_bar(stat = "identity") +
  ylab("Trade Balance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 35, vjust = 1.1, hjust=1, size = 5),
        axis.title.y = element_text(size = 9),
        axis.title.x = element_blank())
```

Automated text to highlight trade balance; difference between value of imports and exports comparing this month to same month in previous year.

# Trade by Trade Agreement

```{r trade by trade agreement, ft.align="left"}
# Create the NSDP table
tradeByTradeAgreement <- data.frame(
  "SITC Description"=c("Food and live animals", "Beverages and tobacco", "Crude materials, inedible, except fuels", 
                       "Mineral fuels, lubricants and related materials", "Animal and vegetable oils, fats and waxes", 
                       "Chemicals and related products, not elsewhere specified", "Manufactured goods classified chiefly by material", 
                       "Machinery and transport equipment", "Miscellaneous manufactured goods",
                       "Commodities and transactions not classified elsewhere in SITC", "Grand Total"),
  "FIJI"=NA, "PAPUA NEW GUINEA"=NA, "SOLOMON ISLANDS"=NA, "Total"=NA,
  check.names=FALSE, stringsAsFactors=FALSE)
# Initiailise a flextable object for NSDP table
tradeByTradeTable <- flextable(tradeByTradeAgreement)
# Add a header row and set background colour
tradeByTradeTable <- add_header_row(tradeByTradeTable, top=TRUE, 
                                  values=c("", "Mellanisain Spearhead Group (MSG)- Trade by Trade Agreement"), 
                                  colwidths=c(1, 4))
tradeByTradeTable <- bg(tradeByTradeTable, bg="coral1", part="header")
# Set the vertical alignment to top
tradeByTradeTable <- valign(tradeByTradeTable, valign="top", part="all")
# Set table width to 100%
tradeByTradeTable <- set_table_properties(tradeByTradeTable, width=1, layout="autofit")
# Set the theme
tradeByTradeTable <- theme_booktabs(tradeByTradeTable)
# Set the cell padding
tradeByTradeTable <- padding(tradeByTradeTable, padding.top=0.6, padding.bottom=0.6, part = "all")
# Make the total row bold
tradeByTradeTable <- bold(tradeByTradeTable, i=nrow(tradeByTradeAgreement))
# Print table
tradeByTradeTable
```

######### Page break

## International Merchandise Trade Statistics - `r format(Sys.Date(), '%B %Y')` Highlights

# Principle Exports

```{r principle exports through time, fig.height=1.75}
# Read in the data from the open folder of the repository 
majorMonthlyExportsFile <- file.path(openDataFolder, "OPN_FINAL_VNSO_MajorMonthlyExportCalculations_31-12-20.csv")
majorMonthlyExports <- read.csv(majorMonthlyExportsFile)
# Convert values
majorMonthlyExports$Year <- as.factor(majorMonthlyExports$Year)
majorMonthlyExports$Copra <- as.numeric(majorMonthlyExports$Copra)
majorMonthlyExports$Coconut.Oil <- as.numeric(majorMonthlyExports$Coconut.Oil)
majorMonthlyExports$Beef <- as.numeric(majorMonthlyExports$Beef)
majorMonthlyExports$Cocoa <- as.numeric(majorMonthlyExports$Cocoa)
majorMonthlyExports$Kava <- as.numeric(majorMonthlyExports$Kava)
# Calculate value of commodities by year
totalValueCommoditiesPerYearAverage <- majorMonthlyExports %>%
  group_by(Year) %>%
  summarise(Copra = (sum(Copra)),
            Coconut.Oil = (sum(Coconut.Oil)),
            Beef = (sum(Beef)),
            Cocoa = (sum(Cocoa)),
            Kava = (sum(Kava)))
# Calculate value of commodities for month
codesCP4 <- c(1000)
categoryColumn <- "Principle.Exports"
columnCategories <- list(
  "Beef fresh, chilled, frozen and preserved"=c("Beef fresh, chilled, frozen and preserved"),
  "Cocoa"=c("Cocoa"),
  "Coconut oil"=c("Coconut Oil"),
  "Copra"=c("Copra"),
  "Kava"=c("Kava"))
# Build the table
totalPrincipleExports <- buildRawSummaryTable(processedTradeStats, codesCP4, categoryColumn, columnCategories)
dummyData <- data.frame(Commodity=rep(c("A", "B"), each=5),
                        Time=rep(c("2016", "2017", "2018", "2019", "November"),2),
                        Value=c(6.8, 15, 33, 42, 35, 4.2, 10, 29.5, 31, 25))
# Create a line graph
ggplot(data=dummyData, aes(x=Time, y=Value, group=Commodity)) +
  geom_line(aes(color=Commodity), size=1.5) +
  theme_minimal()
```

Automated text to say here where the principle exports are destined for, their weight and the unit value of the commodity and make a comparison to same month previous year.

# Top 5 New Major Exports

```{r new major exports, fig.height=1.75}
# Add column to tell us whether each row is import or export
# Create some dummy data
dummyData <- data.frame("Value"=c(rnorm(5, mean=9000, sd=250), rnorm(5, mean=9500, sd=250)), 
                        "Commodity"=c("A", "B", "C", "D", "E"),
                        "Type"=c(rep("Previous", 5), rep("Current", 5)))
# Create a bar chart
ggplot(data=dummyData, aes(x=Commodity, y=Value, fill=Type)) +
  geom_bar(stat="identity", color="black", position=position_dodge()) +
  theme_minimal() + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title=element_blank()) + 
  coord_cartesian(ylim=range(dummyData$Value))
```

Automated text to say here where the principle exports are destined for, their weight and the unit value of the commodity and make a comparison to last month.

<br><br><br><br>

<br><br><br><br>

<br><br><br><br>

# Principle Imports

```{r principle imports through time, fig.height=1.75}
dummyData <- data.frame(Commodity=rep(c("A", "B"), each=5),
                        Time=rep(c("2016", "2017", "2018", "2019", "November"),2),
                        Value=c(50, 76, 96, 65, 86, 30, 60, 45, 75, 80))
# Create a line graph
ggplot(data=dummyData, aes(x=Time, y=Value, group=Commodity)) +
  geom_line(aes(color=Commodity), size=1.5) +
  theme_minimal()
```

Automated text to say here where the principle exports are destined for, their weight and the unit value of the commodity and make a comparison to same month previous year.

# Top 5 New Major Imports

```{r new major imports, fig.height=1.75}
# Create some dummy data
dummyData <- data.frame("Value"=c(rnorm(5, mean=9000, sd=250), rnorm(5, mean=9500, sd=250)), 
                        "Commodity"=c("A", "B", "C", "D", "E"),
                        "Type"=c(rep("Previous", 5), rep("Current", 5)))
# Create a bar chart
ggplot(data=dummyData, aes(x=Commodity, y=Value, fill=Type)) +
  geom_bar(stat="identity", color="black", position=position_dodge()) +
  theme_minimal() + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title=element_blank()) + 
  coord_cartesian(ylim=range(dummyData$Value))
```

Automated text to say here where the principle imports are destined for, their weight and the unit value of the commodity and make a comparison to last month.

# Concluding remarks

This section not automated, instead analysis of the information in partnership with the Ministry of Trades.

######### Page break

## Methodology and meta-data
